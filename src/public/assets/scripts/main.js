Array.isArray(biigle.$require("volumes.stores.filters"))&&biigle.$require("volumes.stores.filters").push({id:"laserpoints",label:"detected laser points",help:"All images that (don't) contain detected laser points.",listComponent:{mixins:[biigle.$require("volumes.components.filterListComponent")],data:function(){return{name:"detected laser points"}}},getSequence:function(e){return biigle.$require("laserpoints.api.volumes").query({id:e})}}),biigle.$viewModel("laserpoints-panel",function(e){new Vue({el:e,mixins:[biigle.$require("core.mixins.loader")],data:{processing:!1,error:!1,distance:null},methods:{detect:function(e,i){this.loading||(i=this.distance||i,this.startLoading(),biigle.$require("api.laserpoints").processImage({image_id:e},{distance:i}).then(this.imageProcessing)["catch"](this.handleError)["finally"](this.finishLoading))},handleError:function(e){422===e.status&&e.data.id?this.error=e.data.id:biigle.$require("messages.store").handleErrorResponse(e)},imageProcessing:function(){this.processing=!0,this.error=!1}}})}),Vue.component("laserpoints-form",{mixins:[biigle.$require("core.mixins.loader")],data:function(){return{volumeId:biigle.$require("volumes.volumeId"),distance:1,processing:!1,error:!1}},computed:{submitDisabled:function(){return this.loading||this.processing}},methods:{submit:function(){this.startLoading(),biigle.$require("api.laserpoints").processVolume({volume_id:this.volumeId},{distance:this.distance}).then(this.volumeProcessing)["catch"](this.handleError)["finally"](this.finishLoading)},handleError:function(e){422===e.status&&e.data.id?this.error=e.data.id:biigle.$require("messages.store").handleErrorResponse(e)},volumeProcessing:function(){this.processing=!0,this.error=!1}}}),biigle.$require("annotations.components.settingsTabPlugins").laserPoints={props:{settings:{type:Object,required:!0}},data:function(){return{opacityValue:"1",currentImageId:null,currentImage:null,cache:{}}},computed:{opacity:function(){return parseFloat(this.opacityValue)},shown:function(){return this.opacity>0},laserpointsApi:function(){return biigle.$require("api.laserpoints")},layer:function(){return new ol.layer.Vector({source:new ol.source.Vector,style:[new ol.style.Style({image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:"white",width:4})})}),new ol.style.Style({image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:"#ff0000",width:2,lineDash:[1]})})})],zIndex:3,updateWhileAnimating:!0,updateWhileInteracting:!0})}},methods:{maybeFetchLaserpoints:function(e){return this.shown&&!this.cache.hasOwnProperty(e)&&(this.cache[e]=this.laserpointsApi.get({image_id:e}).then(function(e){return e.data})),this.cache[e]},updateCurrentImage:function(e,i){this.layer.getSource().clear(),this.currentImageId=e,this.currentImage=i},maybeDrawLaserpoints:function(e){if(e&&"manual"!==e.method&&e.points&&e.points.length>0){var i=this.currentImage.height;this.layer.getSource().addFeatures(e.points.map(function(e){return new ol.Feature({geometry:new ol.geom.Point([e[0],i-e[1]])})}))}}},watch:{opacity:function(e,i){1>e?this.settings.set("laserpointOpacity",e):this.settings["delete"]("laserpointOpacity"),0===i&&this.maybeFetchLaserpoints(this.currentImageId).then(this.maybeDrawLaserpoints),0===e&&this.layer.getSource().clear(),this.layer.setOpacity(e)},currentImageId:function(e){this.shown&&this.maybeFetchLaserpoints(e).then(this.maybeDrawLaserpoints)}},created:function(){this.settings.has("laserpointOpacity")&&(this.opacityValue=this.settings.get("laserpointOpacity"));var e=biigle.$require("biigle.events");e.$on("images.fetching",this.maybeFetchLaserpoints),e.$on("images.change",this.updateCurrentImage);var i=biigle.$require("annotations.stores.map");i.addLayer(this.layer)}},biigle.$declare("api.laserpoints",Vue.resource("api/v1/images{/image_id}/laserpoints",{},{processVolume:{method:"POST",url:"api/v1/volumes{/volume_id}/laserpoints/area"},processImage:{method:"POST",url:"api/v1/images{/image_id}/laserpoints/area"}})),biigle.$declare("laserpoints.api.volumes",Vue.resource("api/v1/volumes{/id}/images/filter/laserpoints"));